<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tidtaker</title>
<style>
    body {
        font-family: Arial, sans-serif;
        text-align: center;
        margin: 30px 0 140px 0;
        background-color: #f4f4f4;
        -webkit-user-select: none;
        user-select: none;
    }

    /* --- SETUP --- */
    #setup {
        margin: 0 auto 30px auto;
        background-color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 25px 30px;
        border-radius: 12px;
        box-shadow: 0 0 12px rgba(0,0,0,0.1);
        max-width: 500px;
    }

    .formInputs {
        margin-bottom: 20px;
        width: 100%;
    }

    label {
        font-size: 1.1em;
        font-weight: bold;
        display: block;
        margin-bottom: 6px;
        color: #333;
    }

        input[type="file"],
        input[type="number"] {
        width: 90%;
        max-width: 220px; /* ðŸ”¹ litt smalere */
        padding: 9px;
        font-size: 1em;
        border-radius: 8px;
        border: 1px solid #ccc;
        transition: 0.2s;
        margin: 3px 6px; /* ðŸ”¹ litt luft mellom feltene */
        }

    input[type="file"] {
        background-color: #f9f9f9;
    }

    input[type="number"]:focus,
    input[type="file"]:focus {
        border-color: #007bff;
        outline: none;
        box-shadow: 0 0 4px rgba(0,123,255,0.4);
    }

    #loadBtn {
        border: none;
        border-radius: 8px;
        background-color: #007bff;
        color: white;
        padding: 12px 25px;
        font-size: 1.1em;
        cursor: pointer;
        transition: background-color 0.3s;
        width: 100%;
        max-width: 250px;
    }

    #loadBtn:hover {
        background-color: #0056b3;
    }

    /* --- TIMER / KNAPPER --- */
    #mainTimer {
        font-size: 2em;
        font-weight: bold;
        margin-bottom: 10px;
    }

    #countdown {
        font-size: 3em;
        margin: 20px 0;
    }

    #nextUp {
        font-size: 1.3em;
        font-weight: 500;
        margin-bottom: 20px;
    }

    #athletes {
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-start;
        gap: 10px;
        margin-top: 20px;
        padding: 0 10px;
    }

    button {
        border: none;
        border-radius: 10px;
        background-color: #007bff;
        color: white;
        padding: 15px 10px;
        font-size: 1.2em;
        width: calc(20% - 10px); /* 5 per rad pÃ¥ store skjermer */
        height: 80px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        transition: background-color 0.3s;
        cursor: pointer;
        touch-action: manipulation;
    }

    button:hover {
        background-color: #0056b3;
    }

    button:disabled {
        background-color: #28a745 !important;
        cursor: default;
    }

    /* --- STARTKNAPP --- */
    #startBtn {
        display: block;
        margin: 0 auto;
        width: calc(20% * 5 + 40px); /* Samme bredde som 5 knapper + mellomrom */
        max-width: 800px;
        height: 70px;
        font-size: 1.4em;
        font-weight: bold;
        border-radius: 12px;
        background-color: #ff9800;
    }

    #startBtn:hover {
        background-color: #e68900;
    }

    /* --- LAST NED-LENKE --- */
    #downloadLink {
        display: none;
        margin-top: 20px;
        padding: 10px 20px;
        background-color: #28a745;
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-weight: bold;
    }

    .bold {
        font-weight: bolder;
        }

    #startFrom {
        margin-bottom: 10px;
    }

    * {
        box-sizing: border-box; /* ðŸ”¹ Hindrer at padding utvider elementer */
    }


  /* --- MOBIL --- */
  @media (max-width: 700px) {
    body {
        overflow-x: hidden; /* ðŸ”¹ Forhindrer sidescroll */
    }
    #setup {
      width: 95%;
      max-width: 95%;
      box-shadow: none;
      padding: 20px 15px;
    }

    #athletes button {
      flex: 1 1 calc(33.333% - 6px);
      max-width: 33.333%;
      width: auto;
    }

    #startBtn {
      width: 95%;
      max-width: none;
    }
    #startFrom, #endAt {
        display: block;
        width: 100%;
        max-width: none;
        margin: 6px 0;
    }
  }
</style>

</head>
<body>
  <h1>TIDTAKER</h1>

  <div id="setup">
    <div class="formInputs">
      <label>Importer startliste (CSV):</label>
    </br>
      <input type="file" id="csvFile" accept=".csv">
    </div>
    <div class="formInputs">
      <label>Manuelt:</label>
    </br>
      <input type="number" id="startFrom" placeholder="FÃ¸rste startnummer">
      <input type="number" id="endAt" placeholder="Siste startnummer">
    </div>
    <div class="formInputs">
      <label>Startintervall (sek):</label>
    </br>
      <input type="number" id="interval" value="20" min="5" max="300">
    </div>
    <button id="loadBtn">Last inn lÃ¸pere</button>
  </div>

  <div id="mainTimer">00:00</div>
  <div id="countdown">20 sek</div>
  <div id="nextUp"></div>
  <button id="startBtn" disabled>Start</button>
  <div id="athletes"></div>
  <a id="downloadLink" download="resultater.csv">Last ned resultater</a>

<script>
  let mainTime = 0;
  let mainTimerInterval;
  let countdown = 20;
  let countdownInterval;
  let startInterval = 20;
  let currentIndex = 0;
  let athletes = []; // {nummer, navn, starttid, resultat}
  let audioCtx = null;
  let useCsv = false;

  const csvFile = document.getElementById("csvFile");
  const startFromEl = document.getElementById("startFrom");
  const endAtEl = document.getElementById("endAt");
  const intervalEl = document.getElementById("interval");
  const loadBtn = document.getElementById("loadBtn");
  const startBtn = document.getElementById("startBtn");
  const mainTimerEl = document.getElementById("mainTimer");
  const countdownEl = document.getElementById("countdown");
  const nextUpEl = document.getElementById("nextUp");
  const athletesEl = document.getElementById("athletes");
  const downloadLink = document.getElementById("downloadLink");

  function beep(duration = 150, frequency = 1000, volume = 1, type = "sine") {
    if (!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.type = type;
    osc.frequency.value = frequency;
    gain.gain.value = volume;
    osc.start();
    osc.stop(audioCtx.currentTime + duration / 1000);
  }

  function formatTime(sec) {
    const m = Math.floor(sec / 60).toString().padStart(2, "0");
    const s = (sec % 60).toString().padStart(2, "0");
    return `${m}:${s}`;
  }

  function startMainTimer() {
    mainTimerInterval = setInterval(() => {
      mainTime++;
      mainTimerEl.textContent = formatTime(mainTime);
    }, 1000);
  }

  function stopMainTimer() {
    clearInterval(mainTimerInterval);
  }

  function playCountdownBeeps(timeLeft) {
    if ([4, 3, 2, 1].includes(timeLeft)) beep(100, 1000, 1, "square");
    else if (timeLeft === 0) beep(700, 1500, 1, "square");
  }

  function addAthleteButton(athlete) {
    const btn = document.createElement("button");
    const numberSpan = document.createElement("span");
    numberSpan.classList.add("number");
    numberSpan.textContent = athlete.nummer;
    const timeSpan = document.createElement("span");
    timeSpan.textContent = "00:00";

    btn.appendChild(numberSpan);
    btn.appendChild(timeSpan);

    const startTime = mainTime;
    const updateInterval = setInterval(() => {
      if (!btn.disabled) {
        const timeNow = mainTime - startTime;
        timeSpan.textContent = formatTime(timeNow);
      }
    }, 500);

    btn.addEventListener("click", () => {
      btn.disabled = true;
      clearInterval(updateInterval);
      const endTime = mainTime - startTime;
      timeSpan.textContent = formatTime(endTime);

      // ðŸ”¹ Oppdater direkte i "athletes"-listen:
      const found = athletes.find(a => a.nummer === athlete.nummer);
      if (found) found.resultat = formatTime(endTime);

      // ðŸ”¹ Sjekk om alle har kommet i mÃ¥l
      if (athletes.every(a => a.resultat)) {
        stopMainTimer();
        generateDownloadFile();
      }
    });

    athletesEl.appendChild(btn);
  }

function generateDownloadFile() {
  let csvContent;
  if (useCsv) {
    csvContent = "startnummer;navn;starttid;resultat\n";
    athletes.sort((a, b) => a.nummer - b.nummer).forEach(a => {
      csvContent += `${a.nummer};${a.navn || ""};${a.starttid || ""};${a.resultat || ""}\n`;
    });
  } else {
    csvContent = "startnummer;tid\n";
    athletes.sort((a, b) => a.nummer - b.nummer).forEach(a => {
      csvContent += `${a.nummer};${a.resultat || ""}\n`;
    });
  }

  // ðŸ”¹ Legg til UTF-8 BOM i starten for norsk tegnstÃ¸tte i Excel
  const bom = "\uFEFF";
  const blob = new Blob([bom + csvContent], { type: "text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  downloadLink.href = url;
  downloadLink.style.display = "inline-block";
}


  function startCountdown(initial = false) {
    countdown = startInterval;
    countdownEl.textContent = countdown;

    countdownInterval = setInterval(() => {
      countdown--;
      countdownEl.textContent = countdown;
      playCountdownBeeps(countdown);

      if (countdown === 0) {
        clearInterval(countdownInterval);

        if (initial) {
          startMainTimer();
          addAthleteButton(athletes[currentIndex]);
          nextUpEl.innerHTML = 'Neste ut: <span class="bold">' + (athletes[currentIndex + 1]?.nummer || "Ingen") + '</span>';
          startCountdown(false);
        } else {
          currentIndex++;
          if (currentIndex < athletes.length) {
            addAthleteButton(athletes[currentIndex]);
            if (currentIndex < athletes.length - 1) {
              nextUpEl.innerHTML = 'Neste ut: <span class="bold">' + athletes[currentIndex + 1].nummer + '</span>';
              startCountdown(false);
            } else {
              nextUpEl.textContent = "Alle har startet";
              countdownEl.textContent = "Ferdig!";
            }
          }
        }
      }
    }, 1000);
  }

  // --- CSV-lesing ---
function parseCSV(text) {
  // Finn riktig skilletegn
  const firstLine = text.split("\n")[0];
  const delimiter = firstLine.includes(";") ? ";" : ",";

  // Del opp i linjer og hopp over header
  const lines = text.trim().split("\n").slice(1);

  return lines.map(line => {
    // Fjern eventuelle anfÃ¸rselstegn og splitt pÃ¥ valgt skilletegn
    const parts = line.replace(/"/g, "").split(delimiter).map(x => x.trim());
    const [nummer, navn, starttid, resultat] = parts;

    return {
      nummer: parseInt(nummer),
      navn: navn || "",
      starttid: starttid || "",
      resultat: ""
    };
  });
}

  loadBtn.addEventListener("click", () => {
    loadBtn.disabled = true;
    document.getElementById("setup").style.display = "none";
    athletes = [];
    downloadLink.style.display = "none";
    athletesEl.innerHTML = "";
    mainTimerEl.textContent = "00:00";
    countdownEl.textContent = startInterval + " sek";
    nextUpEl.textContent = "";

    startInterval = parseInt(intervalEl.value);

    if (csvFile.files.length > 0) {
      const file = csvFile.files[0];
      const reader = new FileReader();
      reader.onload = e => {
        athletes = parseCSV(e.target.result);
        useCsv = true;
        alert(`Lastet inn ${athletes.length} lÃ¸pere fra CSV`);
        startBtn.disabled = false;
      };
      reader.readAsText(file, "UTF-8");
    } else {
      const startFrom = parseInt(startFromEl.value);
      const endAt = parseInt(endAtEl.value);
      if (isNaN(startFrom) || isNaN(endAt) || endAt < startFrom) {
        alert("Ugyldig start- og sluttnummer");
        return;
      }
      for (let i = startFrom; i <= endAt; i++) {
        athletes.push({ nummer: i, resultat: "" });
      }
      useCsv = false;
      alert(`Opprettet ${athletes.length} lÃ¸pere manuelt`);
      startBtn.disabled = false;
      countdownEl.textContent = startInterval + " sek";
    }
  });

  startBtn.addEventListener("click", () => {
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      audioCtx.resume();
    }
    startBtn.disabled = true;
    currentIndex = 0;
    nextUpEl.innerHTML = 'Neste ut: <span class="bold">' + athletes[0].nummer + '</span>';
    startCountdown(true);
  });
</script>

</body>
</html>
